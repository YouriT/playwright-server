openapi: 3.1.0
info:
  title: Playwright Server - Sequential Command Execution
  version: 1.1.0
  description: |
    HTTP API for executing Playwright browser automation commands.
    This version adds support for sequential command execution with timing data.
  contact:
    name: Playwright Server
    url: https://github.com/YouriT/playwright-server

servers:
  - url: http://localhost:3000
    description: Local development server

paths:
  /sessions/{sessionId}/command:
    post:
      summary: Execute command(s) on browser session
      description: |
        Execute a single command or an array of commands sequentially.

        **Backward Compatible**: Existing single-command requests work unchanged.

        **Array Behavior**:
        - Commands execute in order
        - Execution halts on first failure
        - Partial results returned if failure occurs
        - Each result includes execution time

        **Logging**: All executions logged to stdout with session ID.

      operationId: executeCommand

      parameters:
        - name: sessionId
          in: path
          required: true
          description: Session UUID returned from session creation
          schema:
            type: string
            format: uuid
            example: 'abc-123-def-456'

      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - $ref: '#/components/schemas/CommandRequest'
                - $ref: '#/components/schemas/CommandSequenceRequest'
            examples:
              singleCommand:
                summary: Single command (backward compatible)
                value:
                  command: navigate
                  options:
                    url: https://example.com

              commandSequence:
                summary: Command sequence
                value:
                  - command: navigate
                    options:
                      url: https://example.com
                  - command: click
                    selector: '#login-button'
                  - command: type
                    selector: '#username'
                    options:
                      text: user@example.com

      responses:
        '200':
          description: All commands executed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SequenceExecutionResponse'
              examples:
                singleCommandSuccess:
                  summary: Single command success
                  value:
                    results:
                      - index: 0
                        command: navigate
                        status: success
                        result: null
                        durationMs: 1234.56
                    completedCount: 1
                    totalCount: 1
                    halted: false
                    executedAt: '2025-11-22T10:30:45.123Z'

                sequenceSuccess:
                  summary: Full sequence success
                  value:
                    results:
                      - index: 0
                        command: navigate
                        status: success
                        result: null
                        durationMs: 1200.0
                      - index: 1
                        command: click
                        status: success
                        result: null
                        durationMs: 150.5
                      - index: 2
                        command: textContent
                        status: success
                        result: 'Welcome, User!'
                        durationMs: 45.3
                    completedCount: 3
                    totalCount: 3
                    halted: false
                    executedAt: '2025-11-22T10:30:45.123Z'

        '207':
          description: Partial success - some commands executed, then failure
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SequenceExecutionResponse'
              example:
                results:
                  - index: 0
                    command: navigate
                    status: success
                    result: null
                    durationMs: 1200.0
                  - index: 1
                    command: click
                    status: success
                    result: null
                    durationMs: 150.5
                  - index: 2
                    command: type
                    selector: '#missing-field'
                    status: error
                    error: 'Element not found: #missing-field'
                    durationMs: 30.1
                completedCount: 2
                totalCount: 5
                halted: true
                executedAt: '2025-11-22T10:30:45.123Z'

        '400':
          description: Invalid request (validation failed before execution)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                emptyArray:
                  summary: Empty command array
                  value:
                    error: ValidationError
                    message: Command array cannot be empty

                invalidCommand:
                  summary: Invalid command at index
                  value:
                    error: ValidationError
                    message: 'Invalid command at index 1: missing command field'

                unknownCommand:
                  summary: Unknown command name
                  value:
                    error: CommandNotFoundError
                    message: 'Command not found: invalidCommand'

        '404':
          description: Session not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: SessionNotFoundError
                message: 'Session not found: abc-123-def-456'

        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: InternalServerError
                message: Unexpected error during command execution

components:
  schemas:
    CommandRequest:
      type: object
      required:
        - command
      properties:
        command:
          type: string
          description: Command name to execute
          enum:
            - navigate
            - goto
            - click
            - type
            - fill
            - press
            - textContent
            - getAttribute
            - screenshot
            - waitForSelector
            - evaluate
            - setExtraHTTPHeaders
            - cookies
            - setCookies
          example: click

        selector:
          type: string
          description: CSS selector (required for element-based commands)
          example: '#submit-button'

        options:
          type: object
          description: Command-specific options
          additionalProperties: true
          example:
            timeout: 5000

    CommandSequenceRequest:
      type: array
      minItems: 1
      items:
        $ref: '#/components/schemas/CommandRequest'
      example:
        - command: navigate
          options:
            url: https://example.com
        - command: click
          selector: '#button'

    CommandExecutionResult:
      type: object
      required:
        - index
        - command
        - status
        - result
        - durationMs
      properties:
        index:
          type: integer
          description: Position in command sequence (0-based)
          minimum: 0
          example: 0

        command:
          type: string
          description: Command name that was executed
          example: click

        status:
          type: string
          enum:
            - success
            - error
          description: Execution outcome
          example: success

        result:
          description: Command return value (null for void commands, varies by command)
          nullable: true
          example: null

        durationMs:
          type: number
          format: double
          description: Execution time in milliseconds
          minimum: 0
          example: 234.56

        error:
          type: string
          description: Error message (only present when status is error)
          example: 'Element not found: #missing'

        selector:
          type: string
          description: Selector used (for context)
          example: '#submit-button'

    SequenceExecutionResponse:
      type: object
      required:
        - results
        - completedCount
        - totalCount
        - halted
        - executedAt
      properties:
        results:
          type: array
          items:
            $ref: '#/components/schemas/CommandExecutionResult'
          description: Individual command results in execution order

        completedCount:
          type: integer
          description: Number of successfully executed commands
          minimum: 0
          example: 2

        totalCount:
          type: integer
          description: Total number of commands in request
          minimum: 1
          example: 5

        halted:
          type: boolean
          description: True if execution stopped due to failure
          example: true

        executedAt:
          type: string
          format: date-time
          description: ISO 8601 timestamp of execution start
          example: '2025-11-22T10:30:45.123Z'

    ErrorResponse:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          description: Error type/class name
          example: ValidationError

        message:
          type: string
          description: Human-readable error message
          example: Command array cannot be empty
